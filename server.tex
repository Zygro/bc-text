\chapter{Server}

\label{kap:server}

V tejto kapitole sa oboznámime s vnútorným fungovaním servera, používaných bezpečnostných protokoloch
a možnosťami poskytovanými administrátorovi.

\section{Použité technológie}

\subsection{Django 1.9}
Django je open source framework nad programovacím jazykom Python, ktorý uľahčuje vývoj a údržbu webových aplikácií.
Poskytuje funkcionalitu servera na nízkych úrovniach (správa databázy, HTTP komunikácia a iné), čo umožňuje vývojárovi sa sústrediť na tvorbu samotného obsahu.
Django takisto ponúka jednoducho implementovateľné možnosti ochrany pred niektorými najbežnejšími útokmi, ako napríklad XSS, SQL injection alebo CSRF.

Server používa framework Django 1.9 pre jednoduchosť vývoja spravovania databáz, autentifikácie popouživateľov a prostredia pre administrátora.
\subsection{REST framework}
Django REST framework je v projekte využitý na jedoduché a prehľadné zobrazovanie obsahu databázy, odpovedí na HTTP požiadavky a na implementáciu
token autorizácie. Umožňuje priamo v prehliadači posielať a zobraziť odpovede na požiadavky, čo zjednodušuje debugovací proces. Taktiež uľahčujú aj implementáciu externej OAuth
autorizácie o ktorej si povieme neskôr.
\newpage
\section{Testovač}
Testovač je najdôležitejšia časť portálu, pretože dokáže zmerať schopnosti použivateľa. Sú tri možné spôsoby testovania:
\subsection{Stiahnutie vstupov a poslanie výstupov}
\label{testovac1}
Toto je najjednoduchší spôsob implementácie testovača. Použivateľ si z nášho portálu si stiahne testovacie vstupy na ktorých spustí
svoj program, výstup zapíše do súbora a súbor pošle na server, ktorý skontroluje správnosť odpovede.

 Veľká výhoda tohto prístupu je jeho jednoduchosť, ale má značnú nevýhodu: nezaručuje že použivateľ napísal optimálny program.
Účelom portálu je učiť použivateľov dynamické programovanie, ale tento testovač umožňuje správne vyriešiť úlohu aj hrubou silou.

Tento problém by sa dal obísť používaním úloh, ktoré majú mimoriadne časovo zložité riešenie hrubou silou (napríklad \(O(2^n)\)), ktoré by na väčších vstupoch
vyžadovali niekoľko dní počítania.
Toto riešenie je samozrejme nežiadúce keďže veľmi obmedzuje výber úloh. Preto bude používané iba počas procesu vývoja a nie vo finálnom produkte.

\subsection{Testovanie skriptom u použivateľa}

\label{testovac2}
Druhý možný spôsob testovania je rovnaký ako predošlý, až na jednu zmenu: použivateľ si stiahne testovací skript, ktorý spustí použivateľom zadaný program
na vstupoch, ktoré stiahne z nášho servera. Potom odošle výstupy a tie sú porovnané so správnymi odpoveďami.

Toto riešenie nám umožňuje merať čas potrebný na beh programu, čo je značné vylepšenie oproti predošlému riešeniu, pretože ak použivateľ nijak nezasiahne
do skriptu, vieme zistiť či sa mu podarilo úlohu riešiť dynamickým algoritmom.

Použivateľ ale môže skript viacerými spôsobmi napadnúť, napríklad manipulovať s časovým obmedzením alebo získať vstupy, vyriešiť ich iným, pomalším algoritmom a
vytvoriť program ktorý pre každý vstup vypíše správny výstup zo súboru alebo priamo zapísaný v zdrojovom kóde.

Tieto chyby sa dajú vyriešiť zabezpečením skriptu proti útokom, ale žiadna ochrana nie je stopercentná. Mohli by sme teda napríklad neakceptovať výsledky, ktorých podozrivo vyzerajúce
časy (t.j. časy, ktoré sa nesprávajú podľa krivky, časy dlhšie ako limit, ktoré ale skript sa nezastavil atď.). Toto riešenie ale nie je akceptovateľné, pretože by mohlo prepustiť
falšované výsledky alebo odmietnuť správne riešenie.

Na ochranu vstupov sa dá použiť procedurálna generácia alebo náhodné vyberanie z väčšej množiny vstupov, ale tie pridávajú prácu administrátorovi a komplikujú pridávanie nových úloh.

\subsection{Testovanie na servri}
Tretí spôsob testovania prebieha na našom serveri. Použivateľ pošle zdrojový kód svojho riešenia, ten na serveri skompilujeme a vyhodnotíme s časovým obmedzením behu.

Veľkou výhodou je, že použivateľ nemá prístup k testovaným vstupom a správnym výstupom, takže úloha nebude vyhodnotená za správne vyriešenú pri neoptimálnom programe kvôli vyprchaniu časového limitu (závisí od dĺžky vstupu a časového limitu, ktoré zadáva administrátor). Rovnako je oveľa ťažšie napadnúť a upraviť testovač.

Nevýhodou testovača je napríklad zložitá implementácia, pretože musí vedieť kompilovať čo najviac programovacích jazykov a zároveň musíme dávať pozor aby poslaný program nijako nenarušoval bezpečnosť servera (nečítal z pamäťe ktorú nealokoval, nespúšťal žiadne iné programy, nepoužíval niektoré systémové volania a podobne). Ďalšou nevýhodou sú nároky na výpočtový čas servera: keďže proces testovania spúšťa program na serveri, môže server spomaliť.

Nakoľko pri tomto testovači je najťažšie mať správne výsledky v časovom limite a nemať optimálne riešenie, v portáli je implementovaný tento testovač. Ak ale sa zvýši popularita nášho portálu a vznikne problém s rýchlosťou testovania, bude možno treba zvážiť buď vylepšenie hardvéru servera alebo implementáciu predošlého testovača (\ref{testovac2})

\section{Bezpečnosť}
\subsection{Autorizácia}
Portál používa token autentifikáciu ktorá z pohľadu používateľa vyzerá nasledovne:

Používateľ pri prihlasovaní pošle prihlasovacie meno a heslo (tento krok je iný pri prihlasovaní cez externú doménu) a ako odpoveď
dostane náhodne vygenerovaný reťazec o dĺžke približne 40 znakov. Potom všetky požiadavky na použivateľove dáta
 musia v hlavičke uviesť tento token, inak budú zamietnuté.
Server si pamätá použivateľov token až kým sa použivateľ neodhlási alebo mu nevyprší platnosť po dlhšej neaktivite.

Všetky požiadavky musia obsahovať token, čo pomáha použivateľa chrániť napríklad pred CSRF útokom. Narozdiel od cookies,
prehliadač nepridáva token do hlavičky automaticky a teda väčšina CSRF útokov bude zamietnutých.

\subsection{Prihlasovanie cez externé portály}
Portál má viacero možností prihlasovania sa cez externé portály. Použijeme prihlasovaciu schému OAuth 2.0, aby komunikácia s externým
portálom prebiehala iba pri prihlasovaní po ktorom použivateľov prehliadačl komunikuje so serverom ako keby sa prihlásil priamo na náš portál bez využitia externej služby.

Prihlasovanie cez OAuth 2.0 prebieha nasledovne:
\begin{enumerate}
\item{Použivateľ sa prihlási na externý portál a potvrdí našej aplikácii vyžiadané oprávnenia}
\item{Od externého portálu získa prístupový token na ten externý portál}
\item \label{secret}{Tento token pošle nášmu serveru}
\item{Náš server pošle token externému portálu spolu s tajným ID našej aplikácie, aby externý portál vedel, že požiadavka prišla od našej aplikácie}
\item{Ak externý portál potvrdí požiadavku, náš server vráti použivateľovi náš token a ďalej komunikujú iba s týmto novým tokenom.}
\end{enumerate}

Pomocou tejto schémy sa bude dať prihlásiť cez Facebook, Google+ a GitHub.
\newline
(Tajné ID použité v kroku \ref{secret} je prístupné iba administrátorom)

\subsection{Protokoly}
Aby sme chránili použivateľové dáta a token, všetky požiadavky obsahujúce osobné dáta používajú šifrovaný protokol HTTPS. Keďže HTTPS je pomalší na spracovanie,
používame ho iba na potrebné požiadavky. Preto verejne známe informácie, ako napríklad zadania úloh alebo ich zoznam, nemusia byť chránené a používajú rýchlejší HTTP.
\section{Administrácia}
\subsection{Pridávanie a hodnotenie úloh}
Pridávanie a spravovanie úloh je hlavnou povinnosťou administrátora. Administrátor okrem zadávania úloh musí poskytnúť aj vzorové riešenie, prípadne nejaké rady k riešeniu úlohy a zaradiť ju podľa obtiažnosti.

Keďže obtiažnosť úlohy sa niekedy ťažko odhaduje, používatelia budú mať možnosť po správnom vyriešení úlohu ohodnotiť. Budú mať možnosť (ale nie povinnosť) ohodnotiť jej obtiažnosť a zaujímavosť na stupnici od 1 do 5. Tieto hodnotenia sa budú priemerovať.

Administrátor by sa mal snažiť, aby každá úloha mala čo najvyššie hodnotenie zaujímavosti. S hodnotením zložitosti je to ale inak: žiadna úloha by nemala byť príliš ľahká ani príliš ťažká, preto ideálny priemer hodnotenia zložitosti je 3.

Server bude poskytovať administrátorivi možnosť posúvať úlohy vyššie a nižšie v poradí, v ktorom ich používatelia riešia. Takisto bude označovať úlohy, ktoré majú príliš vysokú alebo príliš nízku obtiažnosť vzhľadom na úroveň riešiteľa a navrhovať nové miesto v poradí, kam ich zaradiť. Podobne bude označovať úlohy, ktoré sú považované za najmenej zaujímavé a bude na administrátorovi aby posúdil, či daná nezaujímavá úloha je dôležitá pre proces výučby alebo či ju možno zmeniť alebo odstrániť.
\subsection{Zbieranie dát o použivateľoch}
\label{zbieraniedata}
Náš portál okrem vyučovania dynamického programovania je schopný aj zbierať údaje o schopnostiach použivateľov a ich zlepšovaní sa postupom cez naše vyučovanie. Server bude zbierať viacero možných dát o použivateľskej aktivite:
\begin{itemize}
\item Počet navštívených návodových a teoretických stránok na našom portáli
\item Frekvencia návštev počas riešenia úloh (ako často použivateľ používa naše návody na pomoc s riešením)
\item Priemernú frekvenciu a dĺžku návštev nášho portálu
\item Čas od prečítania úlohy po jej správne vyriešenie (nie veľmi dôležitý, pretože neberie do úvahy prestávky pri riešení)
\item Počet neúspešných pokusov o riešenie
\item Rozdiel priemerného a použivateľovho hodnotenia úlohy (až keď bude dostatočne veľa hodnotení aby tento údaj niečo znamenal)
\end{itemize}

Z týchto údajov budeme vedieť zistiť ako efektívne je vyučovanie (napríklad, žiak sa pravdepodobne zlepšil ak prvé úlohy označoval ťažšie ako priemer a neskoršie ľahšie) a prípadne implementovať automatické zadávanie úloh podľa používateľovych schopností.

\subsection{Oprávnenia použivateľa a administrátora}
Bežní používatelia majú prístup iba k učebným materiálom, odomknutým úlohám (vyriešeným aj nevyriešeným) a svojim riešeniam. Ďalšie úlohy sa používateľovi odomknú, iba ak správne vyrieši všetky prerekvizitové úlohy. Všetky dáta zozbierané servrom (\ref{zbieraniedata}) budú od používateľa skryté, pretože by mohli spôsobiť frustráciu u pomalšie sa učiacich použivateľov.

Administrátor bude mať prístup ku všetkým úlohám, riešeniam, zozbieraným dátam všetkých použivateľov a ich priemerom. Bude mať aj možnosť manuálne meniť niektoré hodnotenia a odomykať alebo zamykať použivateľom úlohy.

Túto možnosť obchádzať pravidlá administrátorovi dávame pre prípad, že vznikne chyba a používateľovi sa napríklad odomkne úloha ku ktorej nemal mať prístup alebo neodomkne taká, ktorej všetky prerekvizity splnil. Používateľ v prípade takejto chyby bude môcť kontaktovať administrátora, ktorý preverí či naozaj nastala chyba a bude ju môcť napraviť bez debugovania servera, čo môže trvať príliš dlho.

\section{Dokumentácia}
\label{dokumentacia}
Django servery sledujú návrhový vzor Model-View-Controller (MVC), kde model je tabuľka
databázy a view je spôsob zobrazenia (napríklad vo forme HTML stránky). Pre pochopenie
funkcionality je dôležité vedieť aké modely používame a ako interagujú, preto sa s nimi
oboznámime. Pri každom modeli spomenieme jeho názov v implementácii a slovenský ekvivalent
tohto názvu.
\subsection{Lesson - úloha}
Úlohy majú tieto polia:
\begin{itemize}
\itemsep0em
\item \textbf{name}: meno úlohy ktoré sa zobrazuje používateľovi.
\item \textbf{problem}: znenie úlohy.
\item \textbf{pub\_date}: dátum publikácie úlohy.
\item \textbf{number}: úroveň úlohy, používateľ musí mať vyriešené všetky povinné úlohy s
  na nižších úrovniach aby mal k tejto úlohe prístup.
\item \textbf{optional}: voliteľnosť úlohy. Povinné aj voliteľné úlohy sa odomykajú rovnako, voliteľné
   ale neodomykajú neskoršie úlohy.
\item \textbf{inputs}: vstupy na ktorých prebieha testovanie úlohy.
\item \textbf{correct\_solution}: správne riešenie, oproti ktorému sa budú testovať používateľské
   riešenia.
\end{itemize}

Pridávanie úloh je jednoduché - stačí vyplniť polia v administrátorskom prostredí
a uložiť. Na každej úrovni ale musí byť práve jedna povinná úloha, preto po upravení
alebo pridaní novej povinnej úlohy sa nasledovným spôsobom upraví poradie:

Najprv sa všetky povinné úlohy posunú tak, aby neboli žiadne medzery v poradí.
Potom všetky povinné úlohy čo majú úroveň väčšiu alebo rovnú úrovni upravovanej/pridanej
úlohy sú posunuté o jednu úroveň vyššie (upravovaná/pridaná úloha nie je posunutá).
Potom sú všetky úlohy znovu posunuté tak aby neboli medzery (pre prípad, že administrátor
urobil chybu a pridal úlohu s číslom väčším ako má byť najvyššia úroveň, napríklad
ak je 6 povinných úloh a novej úlohe zadá úroveň 10).

Na úlohy máme tri rôzne pohľady (views): Jeden ktorý vráti všetky úrovne, voliteľnosti a názvy úloh ku ktorým má
používateľ prístup, druhý meno, znenie a úroveň s voliteľnosťou jednej úlohy a tretí
iba vstupy alebo skript na stiahnutie (ak používame testovač \ref{testovac1} alebo \ref{testovac2})

\subsection{Submit - riešenie}
Riešenie ktoré používateľ pošle na server na otestovanie.

Polia:
\begin{itemize}
\item \textbf{user}: používateľ ktorý riešenie poslal
\item \textbf{lesson}: úloha ktorú používateľ rieši týmto riešením
\item \textbf{submittedFile}: súbor s riešením, ktoré bude odovzdané testovaču
\item \textbf{result}: výsledok - pravda ak bolo riešenie správne, nepravda ak nebolo
\end{itemize}

Hneď ako server dostane nové riešenie, spustí testovač a jeho odpoveď uloží v poli
\textbf{result}. Ak nie je správne, riešenie uložíme a pokračujeme v činnosti ako pred jeho poslaním.
Ak testovač ale vyhodnotí riešenie ako správne, pred jeho uložením zvýši používateľovu
úroveň o 1 (ak je úloha povinná) a označí úlohu ako vyriešenú.

\subsection{Comment - komentár}
Komentár od používateľa na úlohu.
Polia:
\begin{itemize}
\item \textbf{user}: používateľ ktorý vytvoril komentár
\item \textbf{lesson}: úloha ku ktorej bol komentár pridaný
\item \textbf{text}: text komentára
\item \textbf{date}: čas vytvorenia komentára, potrebný na zoraďovanie pri zobrazení
\end{itemize}

Pri komentároch sa bude zobrazovať aj úroveň autora a to, či úlohu vyriešil.
Zatiaľ sú všetky komentáre prístupné všetkým používateľom (ak majú prístup k ich úlohe)

Je možné že rozdelíme diskusie pre tých čo úlohu vyriešili a tých čo ešte nie
alebo povolíme diskusiu iba pre úspešných riešiteľov, aby žiaden používateľ nemohol
v diskusii prezradiť správne riešenie ostatným používateľom ktorí ešte úlohu nevyriešili.

\subsection{Hint - rada}
Rada k úlohe, pre prípad že ju používateľ nevie riešiť.

Polia:
\begin{itemize}
\item \textbf{lesson}: úloha ku ktorej je táto rada
\item \textbf{number}: poradové číslo rady
\item \textbf{text}: text rady
\end{itemize}
